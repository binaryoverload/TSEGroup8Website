let covidMap={},cumulativeColorScale=[],dailyColorScale=[],colorScale=["#fcde95","#fc9860","#f5614b","#dc3852","#ba2760","#941b6a","#79146e","#50046d","#300061","#0c0920"];function getSliderDate(e){let t=new Date(2020,0,31);return t.setDate(t.getDate()+e),t}function dateUpdate(e){document.getElementById("date").innerText=e,setStyles(e)}function getSliderDateString(e){let t=getSliderDate(parseInt(e));return`${Math.max(t.getDate(),1).toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()}`}function getGradientColor(e,t){for(let a of t)if(e<a.max&&e>=a.min)return a.color;return"#000000"}function setStyles(e){window.cumulativeMap.eachLayer(function(t){if(t.setStyle&&t.feature){let a=void 0;covidMap[e][t.feature.properties.code]&&(a=covidMap[e][t.feature.properties.code].cumulativeColor),t.setStyle({color:a,weight:1})}}),window.dailyMap.eachLayer(function(t){if(t.setStyle&&t.feature){let a=void 0;covidMap[e][t.feature.properties.code]&&(a=covidMap[e][t.feature.properties.code].dailyColor),t.setStyle({color:a,weight:1})}})}!async function(){window.cumulativeMap=L.map("cumulative-map").setView([54.898,-5.416],6),window.dailyMap=L.map("daily-map").setView([54.898,-5.416],6);let e=L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>, <a href="https://coronavirus.data.gov.uk/details/interactive-map#:~:text=Attributions">Data and Boundaries © </a>',maxZoom:18,id:"mapbox/light-v10",tileSize:512,zoomOffset:-1,accessToken:"pk.eyJ1IjoiYmluYXJ5b3ZlcmxvYWQiLCJhIjoiY2tsbXN2dDg5MGNlMDJvbXVicnN3Y2RxOSJ9.yCG6Sk6vz7qdhVT2gsWkpA"}),t=L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>, <a href="https://coronavirus.data.gov.uk/details/interactive-map#:~:text=Attributions">Data and Boundaries © </a>',maxZoom:18,id:"mapbox/light-v10",tileSize:512,zoomOffset:-1,accessToken:"pk.eyJ1IjoiYmluYXJ5b3ZlcmxvYWQiLCJhIjoiY2tsbXN2dDg5MGNlMDJvbXVicnN3Y2RxOSJ9.yCG6Sk6vz7qdhVT2gsWkpA"});e.addTo(window.cumulativeMap),t.addTo(window.dailyMap);let a=await fetch("/static/countyCodes.json").then(e=>e.json()),o=await fetch("https://coronavirus.data.gov.uk/downloads/maps/utla-ref.geojson").then(e=>e.json());window.covidData=await fetch("/static/covid-data.csv").then(e=>e.text()).then(e=>e.split("\n").map(e=>e.split(/,(?![^,]+")/g)));let i=getSliderDateString(document.getElementById("slider").value),r=window.covidData.map(e=>({date:e[0],countyCode:e[2],cumulative:Number(e[4]),daily:Number(e[5])})),l=r.reduce((e,t)=>isNaN(t.cumulative)?e:(e.push(t.cumulative),e),[]).sort((e,t)=>e-t),d=[];for(let e=1;e<=10;e++){let t=l[Math.floor((l.length-1)*(e/10))];t=Number(t.toPrecision(2)),1===e&&(t=0),d.push(t)}let n=r.reduce((e,t)=>isNaN(t.daily)?e:(e.push(t.daily),e),[]).sort((e,t)=>e-t),c=[];for(let e=1;e<=10;e++){let t=n[Math.floor((n.length-1)*(e/10))];t=Number(t.toPrecision(2)),1===e&&(t=0),c.push(t)}for(let e=0;e<d.length;e++)cumulativeColorScale.push({min:d[e],max:d[e+1]||Number.MAX_VALUE,color:colorScale[e]}),document.querySelector("#cumulative-container > .overlay").innerHTML+=`<div class="overlay-percentile-${e+1}"><span></span>${d[e]}${d[e+1]?" - "+d[e+1]:"+"}</div>`;for(let e=0;e<c.length;e++)dailyColorScale.push({min:c[e],max:c[e+1]||Number.MAX_VALUE,color:colorScale[e]}),document.querySelector("#daily-container > .overlay").innerHTML+=`<div class="overlay-percentile-${e+1}"><span></span>${c[e]}${c[e+1]?" - "+c[e+1]:"+"}</div>`;covidMap=r.reduce((e,t)=>{if("date"===t.date)return e;let a={};return a.cumulative=+t.cumulative,a.daily=+t.daily,a.cumulativeColor=getGradientColor(+t.cumulative,cumulativeColorScale),a.dailyColor=getGradientColor(+t.daily,dailyColorScale),e[t.date]?e[t.date][t.countyCode]=a:(e[t.date]={},e[t.date][t.countyCode]=a),e},{}),dateUpdate(i);L.geoJSON(o).bindTooltip(function(e){let t=covidMap[getSliderDateString(document.getElementById("slider").value)][e.feature.properties.code];return a[e.feature.properties.code]+" ("+e.feature.properties.code+") - "+(t?t.cumulative:"No Data")}).addTo(window.cumulativeMap),L.geoJSON(o).bindTooltip(function(e){let t=covidMap[getSliderDateString(document.getElementById("slider").value)][e.feature.properties.code];return a[e.feature.properties.code]+" ("+e.feature.properties.code+") - "+(t?t.daily:"No Data")}).addTo(window.dailyMap);dateUpdate(getSliderDateString(document.getElementById("slider").value)),console.log(JSON.stringify(covidMap))}(),document.getElementById("slider").addEventListener("input",function(e){dateUpdate(getSliderDateString(e.target.value))});